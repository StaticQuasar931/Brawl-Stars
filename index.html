<!DOCTYPE html>
<html lang="en-us">
<head>
  <meta charset="utf-8"/>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
  <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes"/>
  <title>Clicker</title>
  <style>
    html, body { width:100%; height:100%; padding:0; margin:0; }
    .fullscreen { background:#242424; width:100%; height:100%; position:absolute; top:0; left:0; }
    #banner-container { position:absolute; bottom:0; width:100%; height:90px; display:none !important; }
    #loading-overlay { font-size:20px; z-index:1; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    #icon { max-width:300px; border-radius:10px; margin-bottom:20px; }
    #progress-bar { border-radius:5px; width:90%; max-width:250px; height:20px; background:#181818; padding:5px; }
    #progress-bar-fill { border-radius:3px; width:0%; height:100%; background:#9747FF; transition:width .2s linear; }
  </style>
</head>
<body>
  <canvas id="canvas" class="fullscreen"></canvas>
  <div id="banner-container"></div>
  <div id="loading-overlay" class="fullscreen">
    <img id="icon" src="./icon.png" alt="icon"/>
    <div id="progress-bar"><div id="progress-bar-fill"></div></div>
  </div>

  <!-- Your local libs -->
  <script src="add/howler.js"></script>
  <script src="add/mo.js"></script>
  <script src="playgama-bridge.js"></script>

  <script>
    // elements
    const canvas = document.getElementById('canvas');
    const loadingOverlay = document.getElementById('loading-overlay');
    const progressBarFill = document.getElementById('progress-bar-fill');

    // globals Unity expects
    window.unityInstance = null;
    window.sounds = {};           // <-- required by your Unity JS hooks
    window.sound = null;          // optional single sound handle some code uses
    window.isSound = 1;

    // progress bar
    let progressBarFillingInterval = null;
    let progressBarCompleteFillingStarted = false;

    function onUnityLoadingProgressChanged(progress) {
      if (progress >= 1 && progressBarFillingInterval !== null) {
        clearInterval(progressBarFillingInterval);
        progressBarFillingInterval = null;
        return;
      }
      if (progressBarCompleteFillingStarted) return;
      if (progress >= 0.9) {
        progressBarCompleteFillingStarted = true;
        completeProgressBarFilling();
        return;
      }
      progressBarFill.style.width = (progress * 100) + '%';
    }

    function completeProgressBarFilling() {
      if (progressBarFillingInterval !== null) return;
      let currentPercent = 90;
      progressBarFill.style.width = currentPercent + '%';
      progressBarFillingInterval = setInterval(() => {
        currentPercent++;
        if (currentPercent > 100) currentPercent = 100;
        progressBarFill.style.width = currentPercent + '%';
        if (currentPercent >= 100) {
          clearInterval(progressBarFillingInterval);
          progressBarFillingInterval = null;
        }
      }, 100);
    }

    // focus canvas on first input
    window.addEventListener('pointerdown', () => {
      window.focus();
      canvas.focus();
    });

    // send message helper
    function sendMessageToUnity(name, value) {
      if (window.unityInstance && typeof window.unityInstance.SendMessage === 'function') {
        window.unityInstance.SendMessage('PlaygamaBridge', name, value || '');
      }
    }

    // Howler helpers
    function ensureHowlerReady() {
      return new Promise((resolve) => {
        const start = Date.now();
        (function waitForHowl() {
          if (typeof window.Howl === 'function') return resolve(true);
          if (Date.now() - start > 3000) return resolve(false);
          setTimeout(waitForHowl, 25);
        })();
      });
    }

    function initMutedLoop() {
      try {
        const s = new Howl({ src: ['silent.mp3'], loop: true, volume: 0 });
        s.play();
        return s;
      } catch (e) {
        console.warn('Howler init failed:', e);
        return null;
      }
    }

    // exposed volume toggles
    function HowlerSoundOff(){ if (window.Howler && Howler.volume) { window.isSound = 0; Howler.volume(0); } }
    function HowlerSoundOn(){  if (window.Howler && Howler.volume) { window.isSound = 1; Howler.volume(1); } }
    window.HowlerSoundOff = HowlerSoundOff;
    window.HowlerSoundOn  = HowlerSoundOn;

    // simple registry used by Unity side
    // these are safe no-ops if Howler is missing
    window.LoadSound = function(name, src, loopStr, volStr){
      try {
        const loop = loopStr === true || loopStr === 'true';
        const volume = Math.max(0, Math.min(1, parseFloat(volStr || 1)));
        const howl = new Howl({ src: [src], loop, volume });
        window.sounds[name] = howl;
      } catch(e) {
        console.warn('LoadSound failed', name, src, e);
      }
    };

    window.PlaySound = function(name){
      try {
        const h = window.sounds[name];
        if (h) { h.play(); window.sound = h; }
      } catch(e) {
        console.warn('PlaySound failed', name, e);
      }
    };

    window.StopSound = function(name){
      try {
        const h = window.sounds[name];
        if (h) h.stop();
      } catch(e) {
        console.warn('StopSound failed', name, e);
      }
    };

    window.SetSoundVolume = function(name, volStr){
      try {
        const h = window.sounds[name];
        if (h) h.volume(Math.max(0, Math.min(1, parseFloat(volStr))));
      } catch(e) {
        console.warn('SetSoundVolume failed', name, e);
      }
    };

    window.openUrlInNewTab = function(url){ window.open(url, '_blank'); };
    window.getServerTime = () => sendMessageToUnity('OnGetServerTimeCompleted', Date.now().toString());

    // boot
    (async function boot() {
      const howlerOk = await ensureHowlerReady();
      if (howlerOk) initMutedLoop();
      else console.error('Howler not loaded. Check add/howler.js path.');

      // load Unity loader
      try {
        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = 'Build/web.loader.js';
          s.onload = resolve;
          s.onerror = () => reject(new Error('web.loader.js failed to load'));
          document.body.appendChild(s);
        });
      } catch (e) {
        console.error(e.message);
        alert('Oyun yüklenemedi. Lütfen sayfayı yenileyin.');
        return;
      }

      if (typeof createUnityInstance !== 'function') {
        console.error('createUnityInstance is not available.');
        alert('Oyun yüklenemedi. Lütfen sayfayı yenileyin.');
        return;
      }

      // start Unity
      try {
        const instance = await createUnityInstance(
          canvas,
          {
            dataUrl: 'Build/web.data.unityweb',
            frameworkUrl: 'Build/web.framework.js.unityweb',
            codeUrl: 'Build/web.wasm.unityweb',
            streamingAssetsUrl: 'StreamingAssets',
            companyName: 'DefaultCompany',
            productName: 'Clicker',
            productVersion: '0.1'
          },
          onUnityLoadingProgressChanged
        );
        window.unityInstance = instance;
        loadingOverlay.remove();
        canvas.focus();
      } catch (error) {
        console.error('Unity yüklenemedi:', error);
        alert('Oyun yüklenemedi. Lütfen sayfayı yenileyin.');
      }
    })();
  </script>
</body>
</html>
